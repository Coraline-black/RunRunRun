<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Бабушка — Runner</title>

<style>
body {
  margin: 0;
  background: #000;
  overflow: hidden;
  font-family: Arial, sans-serif;
}

canvas {
  display: block;
  margin: auto;
  background: #333;
}

#ui {
  position: absolute;
  top: 10px;
  left: 10px;
  color: white;
}

#over {
  position: absolute;
  inset: 0;
  display: none;
  background: rgba(0,0,0,0.85);
  color: white;
  align-items: center;
  justify-content: center;
  flex-direction: column;
}
button {
  padding: 10px 20px;
  font-size: 16px;
}
</style>
</head>
<body>

<div id="ui">
  Очки: <span id="score">0</span><br>
  Дистанция: <span id="dist">0</span>
</div>

<div id="over">
  <h1>Game Over</h1>
  <p>Очки: <span id="final"></span></p>
  <button onclick="restart()">Заново</button>
</div>

<canvas id="game" width="420" height="640"></canvas>

<script>
// ====== НАСТРОЙКИ ======
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const lanes = [120, 190, 260];
let speed = 3.5;
let score = 0;
let dist = 0;
let run = true;

// ====== ЗАГРУЗКА БАБУШКИ ======
const grandma = new Image();
grandma.src = "grandma.png";

// ====== ИГРОК ======
const player = {
  lane: 1,
  y: 440,
  vy: 0,
  state: "run",
  w: 60,
  h: 80
};

let coins = [];
let obs = [];

// ====== КЛАВИАТУРА ======
document.addEventListener("keydown", e => {
  if (!run) return;

  if ((e.key === "ArrowLeft" || e.key === "a") && player.lane > 0) player.lane--;
  if ((e.key === "ArrowRight" || e.key === "d") && player.lane < 2) player.lane++;

  if ((e.key === "ArrowUp" || e.key === " " || e.key === "w") && player.state === "run") {
    player.vy = -16;
    player.state = "jump";
  }

  if ((e.key === "ArrowDown" || e.key === "s") && player.state === "run") {
    player.state = "slide";
    setTimeout(() => player.state = "run", 600);
  }
});

// ====== ТАЧ ======
let sx = 0, sy = 0;
canvas.addEventListener("touchstart", e => {
  sx = e.touches[0].clientX;
  sy = e.touches[0].clientY;
});
canvas.addEventListener("touchend", e => {
  let dx = e.changedTouches[0].clientX - sx;
  let dy = e.changedTouches[0].clientY - sy;

  if (Math.abs(dx) > Math.abs(dy)) {
    if (dx > 30 && player.lane < 2) player.lane++;
    if (dx < -30 && player.lane > 0) player.lane--;
  } else {
    if (dy < -30 && player.state === "run") {
      player.vy = -16;
      player.state = "jump";
    }
    if (dy > 30 && player.state === "run") {
      player.state = "slide";
      setTimeout(() => player.state = "run", 600);
    }
  }
});

// ====== ГЕНЕРАЦИЯ ======
function spawnCoin() {
  coins.push({ lane: Math.floor(Math.random()*3), y: -20 });
}
function spawnObs() {
  obs.push({
    lane: Math.floor(Math.random()*3),
    y: -60,
    type: Math.random() > 0.5 ? "low" : "high"
  });
}

// ====== ЛОГИКА ======
function update() {
  if (!run) return;

  speed += 0.0005;
  dist += speed * 0.1;

  player.y += player.vy;
  player.vy += 1;
  if (player.y >= 440) {
    player.y = 440;
    player.vy = 0;
    if (player.state === "jump") player.state = "run";
  }

  coins.forEach(c => c.y += speed);
  obs.forEach(o => o.y += speed);

  coins = coins.filter(c => c.y < 700);
  obs = obs.filter(o => o.y < 700);

  coins.forEach((c,i) => {
    if (c.lane === player.lane && Math.abs(c.y - player.y) < 30) {
      score++;
      coins.splice(i,1);
    }
  });

  obs.forEach(o => {
    if (o.lane === player.lane && Math.abs(o.y - player.y) < 40) {
      if ((o.type === "low" && player.state !== "jump") ||
          (o.type === "high" && player.state !== "slide")) {
        gameOver();
      }
    }
  });

  if (Math.random() < 0.03) spawnCoin();
  if (Math.random() < 0.02) spawnObs();

  document.getElementById("score").textContent = score;
  document.getElementById("dist").textContent = Math.floor(dist);
}

// ====== ОТРИСОВКА ======
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle = "#444";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // бабушка (ГГ)
  let h = player.state === "slide" ? 50 : 80;
  ctx.drawImage(
    grandma,
    lanes[player.lane] - 10,
    player.y + (80 - h),
    80,
    h
  );

  // монеты
  ctx.fillStyle = "gold";
  coins.forEach(c => {
    ctx.beginPath();
    ctx.arc(lanes[c.lane]+20, c.y, 10, 0, Math.PI*2);
    ctx.fill();
  });

  // препятствия
  obs.forEach(o => {
    ctx.fillStyle = o.type === "low" ? "#654321" : "#882222";
    ctx.fillRect(lanes[o.lane], o.y, 40, 40);
  });
}

// ====== GAME OVER ======
function gameOver() {
  run = false;
  document.getElementById("final").textContent = score;
  document.getElementById("over").style.display = "flex";
}
function restart() {
  speed = 3.5;
  score = 0;
  dist = 0;
  coins = [];
  obs = [];
  run = true;
  document.getElementById("over").style.display = "none";
}

// ====== ЦИКЛ ======
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
