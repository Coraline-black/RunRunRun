<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Бабушка — Endless Runner</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  overflow: hidden;
  font-family: Arial, sans-serif;
}

canvas {
  display: block;
  margin: auto;
  background: #2b2b2b;
}

#ui {
  position: absolute;
  top: 10px;
  left: 10px;
  color: #fff;
  font-size: 16px;
  z-index: 5;
}

#gameOver {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.85);
  color: white;
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 10px;
  z-index: 10;
}

button {
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
}
</style>
</head>
<body>

<div id="ui">
  Очки: <span id="score">0</span><br>
  Дистанция: <span id="dist">0</span><br>
  Рекорд: <span id="best">0</span>
</div>

<div id="gameOver">
  <h1>Game Over</h1>
  <p>Очки: <span id="finalScore"></span></p>
  <p>Дистанция: <span id="finalDist"></span></p>
  <button onclick="restart()">Заново</button>
</div>

<canvas id="game" width="420" height="640"></canvas>

<script>
/* ================== НАСТРОЙКИ ================== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const lanes = [110, 190, 270];
let speed = 3.5;
let score = 0;
let distance = 0;
let multiplier = 1;
let running = true;
let best = localStorage.getItem("best") || 0;

/* ================== ИГРОК ================== */
const player = {
  lane: 1,
  y: 440,
  vy: 0,
  state: "run", // run jump slide
  w: 40,
  h: 70
};

/* ================== ОБЪЕКТЫ ================== */
let coins = [];
let obstacles = [];

/* ================== УПРАВЛЕНИЕ (КЛАВА) ================== */
document.addEventListener("keydown", e => {
  if (!running) return;

  if ((e.key === "ArrowLeft" || e.key === "a") && player.lane > 0) player.lane--;
  if ((e.key === "ArrowRight" || e.key === "d") && player.lane < 2) player.lane++;

  if ((e.key === "ArrowUp" || e.key === "w" || e.key === " ") && player.state === "run") {
    player.vy = -16;
    player.state = "jump";
  }

  if ((e.key === "ArrowDown" || e.key === "s") && player.state === "run") {
    player.state = "slide";
    setTimeout(() => player.state = "run", 600);
  }
});

/* ================== СВАЙПЫ ================== */
let sx = 0, sy = 0;

canvas.addEventListener("touchstart", e => {
  sx = e.touches[0].clientX;
  sy = e.touches[0].clientY;
});

canvas.addEventListener("touchend", e => {
  let dx = e.changedTouches[0].clientX - sx;
  let dy = e.changedTouches[0].clientY - sy;

  if (Math.abs(dx) > Math.abs(dy)) {
    if (dx > 30 && player.lane < 2) player.lane++;
    if (dx < -30 && player.lane > 0) player.lane--;
  } else {
    if (dy < -30 && player.state === "run") {
      player.vy = -16;
      player.state = "jump";
    }
    if (dy > 30 && player.state === "run") {
      player.state = "slide";
      setTimeout(() => player.state = "run", 600);
    }
  }
});

/* ================== ГЕНЕРАЦИЯ ================== */
function spawnCoin() {
  coins.push({
    lane: Math.floor(Math.random() * 3),
    y: -20,
    value: Math.random() < 0.2 ? 5 : 1
  });
}

function spawnObstacle() {
  obstacles.push({
    lane: Math.floor(Math.random() * 3),
    y: -60,
    type: Math.random() > 0.5 ? "low" : "high"
  });
}

/* ================== ЛОГИКА ================== */
function update() {
  if (!running) return;

  speed += 0.0007;
  distance += speed * 0.1;
  multiplier += 0.0005;

  player.y += player.vy;
  player.vy += 1;

  if (player.y >= 440) {
    player.y = 440;
    player.vy = 0;
    if (player.state === "jump") player.state = "run";
  }

  coins.forEach(c => c.y += speed);
  obstacles.forEach(o => o.y += speed);

  coins = coins.filter(c => c.y < 700);
  obstacles = obstacles.filter(o => o.y < 700);

  coins.forEach((c, i) => {
    if (c.lane === player.lane && Math.abs(c.y - player.y) < 30) {
      score += c.value * Math.floor(multiplier);
      coins.splice(i, 1);
    }
  });

  obstacles.forEach(o => {
    if (o.lane === player.lane && Math.abs(o.y - player.y) < 40) {
      if (
        (o.type === "low" && player.state !== "jump") ||
        (o.type === "high" && player.state !== "slide")
      ) endGame();
    }
  });

  if (Math.random() < 0.03) spawnCoin();
  if (Math.random() < 0.02) spawnObstacle();

  document.getElementById("score").textContent = score;
  document.getElementById("dist").textContent = Math.floor(distance);
  document.getElementById("best").textContent = best;
}

/* ================== ОТРИСОВКА ================== */
let roadY = 0;

function drawRoad() {
  roadY += speed;
  if (roadY > 40) roadY = 0;

  ctx.fillStyle = "#3a3a3a";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.strokeStyle = "#777";
  lanes.forEach(x => {
    ctx.beginPath();
    ctx.moveTo(x + 20, 0);
    ctx.lineTo(x + 20, canvas.height);
    ctx.stroke();
  });
}

function drawPlayer() {
  let h = player.state === "slide" ? 40 : 70;

  // тело
  ctx.fillStyle = "#1E1E1E";
  ctx.fillRect(lanes[player.lane], player.y + (70 - h), 40, h);

  // накидка
  ctx.fillStyle = "#F2F2F2";
  ctx.fillRect(lanes[player.lane], player.y - 10, 40, 20);

  // волосы
  ctx.fillStyle = "#C86A3A";
  ctx.fillRect(lanes[player.lane] + 10, player.y - 30, 20, 20);

  // очки
  ctx.strokeStyle = "#CCCCCC";
  ctx.strokeRect(lanes[player.lane] + 12, player.y - 24, 16, 8);
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawRoad();
  drawPlayer();

  coins.forEach(c => {
    ctx.fillStyle = c.value === 5 ? "orange" : "gold";
    ctx.beginPath();
    ctx.arc(lanes[c.lane] + 20, c.y, 10, 0, Math.PI * 2);
    ctx.fill();
  });

  obstacles.forEach(o => {
    ctx.fillStyle = o.type === "low" ? "#654321" : "#882222";
    ctx.fillRect(lanes[o.lane], o.y, 40, 40);
  });
}

/* ================== GAME OVER ================== */
function endGame() {
  running = false;
  if (score > best) {
    best = score;
    localStorage.setItem("best", best);
  }
  document.getElementById("finalScore").textContent = score;
  document.getElementById("finalDist").textContent = Math.floor(distance);
  document.getElementById("gameOver").style.display = "flex";
}

function restart() {
  speed = 3.5;
  score = 0;
  distance = 0;
  multiplier = 1;
  coins = [];
  obstacles = [];
  running = true;
  document.getElementById("gameOver").style.display = "none";
}

/* ================== ЦИКЛ ================== */
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
